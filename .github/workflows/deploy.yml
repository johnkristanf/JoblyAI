name: joblyai-server-deploy

on:
  workflow_run:
    workflows: ["joblyai-server-build"]
    types:
      - completed

    branches:
      - production
jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code 
        uses: actions/checkout@v3
        with:
          ref: production
          
      - name: View docker-compose.yml contents
        run: |
          echo "=== START docker-compose.yml ==="
          cat server/docker-compose.yml
          echo "=== END docker-compose.yml ==="

      - name: Deploy to EC2 using in-memory SSH key 
        run: |
          # Start a temporary SSH agent
          eval "$(ssh-agent -s)"

          # Add the SSH key from the GitHub secret
          echo "${{ secrets.EC2_SSH_KEY }}" | ssh-add - >/dev/null

          # Copy docker-compose.yml to EC2
          scp -o StrictHostKeyChecking=no server/docker-compose.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/docker-compose.yml

          # Connect via SSH and deploy
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/${{ secrets.EC2_USER }}
            docker compose pull
            docker compose up -d --remove-orphans
          EOF

          # Kill the temporary SSH agent
          ssh-agent -k

